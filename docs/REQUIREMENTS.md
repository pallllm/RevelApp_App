# RevelApp Customer Portal - 要件定義書

**バージョン**: 1.2
**最終更新**: 2026年1月16日
**ステータス**: Draft

---

## 1. プロジェクト概要

### 1.1 システム名
RevelApp Customer Portal（レベルアップ カスタマーポータル）

### 1.2 システム概要
RevelAppの顧客ポータルアプリケーション。施設スタッフが利用者管理、工賃管理、体調記録などを一元的に行うためのWebシステム。

### 1.3 対象ユーザー
| ユーザー種別 | 説明 | 想定人数/施設 |
|------------|------|--------------|
| 施設スタッフ&管理者 | 施設の支援員・職員・管理者 | 3〜5名 |

※ 本ツールでは、施設あたり1アカウントなので、対象ユーザー毎にアカウントを分けたりは不要

---

## 2. ビジネス要件

### 2.1 ビジネス目標
1. 100施設程度の契約を耐えられる自動化・仕組み化の体制を構築する
2. 利用者の工賃情報を正確かつリアルタイムに把握可能にする
3. 体調記録を可視化し、利用者への適切な支援を実現する
4. 契約・申請業務のペーパーレス化を推進する

### 2.2 成功指標（KPI）
| 指標 | 目標値 | 測定方法 |
|-----|-------|---------|
| 月次工賃計算時間 | 50%削減 | 作業時間の比較 |
| 変更申請処理時間 | 3営業日以内 | 申請〜承認の日数 |
| システム稼働率 | 60%以上 | システムを活用できる契約施設数の割合 |

---

## 3. 機能要件

### 3.1 機能一覧

#### 3.1.1 ダッシュボード機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-001 | 施設基本情報表示 | 必須 | 実装済 |
| F-002 | 利用者数統計表示 | 必須 | 実装済 |
| F-003 | 継続月数・工賃フェーズ表示 | 必須 | 実装済 |
| F-004 | 月間プレイ回数表示 | 必須 | 実装済 |
| F-005 | Googleカレンダー連携 | 必須 | 実装済 |
| F-006 | お知らせ表示 | 必須 | 実装済 |

#### 3.1.2 利用者管理機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-010 | 利用者一覧表示 | 必須 | 実装済 |
| F-011 | 利用者詳細表示 | 必須 | 実装済 |
| F-012 | 利用者追加申請 | 必須 | 実装済 |
| F-013 | 利用者削除申請 | 必須 | 実装済 |
| F-014 | 利用者情報編集 | 高 | 一部実装 |
| F-015 | モニタリングシート連携 | 高 | 実装済 |

#### 3.1.3 ゲーム管理機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-020 | ゲーム一覧表示 | 必須 | 実装済 |
| F-021 | ゲーム詳細表示 | 必須 | 実装済 |
| F-022 | ゲームレベル別フィルタ | 必須 | 実装済 |
| F-023 | ゲームマニュアル表示 | 高 | 実装済 |
| F-024 | ゲーム動画ガイド表示 | 高 | 実装済 |
| F-025 | ゲーム変更申請 | 必須 | 実装済 |

#### 3.1.4 体調記録機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-030 | 月別体調グラフ表示 | 必須 | 実装済 |
| F-031 | 利用者別体調記録表示 | 必須 | 実装済 |
| F-032 | 体調記録入力 | 必須 | 実装済 |
| F-033 | 複数利用者比較表示 | 高 | 実装済 |
| F-034 | 体調記録PDF出力 | 中 | 実装済 |
| F-035 | 天気・気圧情報連携 | 中 | 実装済 |

#### 3.1.5 工賃管理機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-040 | 月次工賃表示 | 必須 | 実装済 |
| F-041 | 工賃履歴表示 | 必須 | 実装済 |
| F-042 | 利用者別工賃内訳表示 | 必須 | 実装済 |
| F-043 | 繰越金表示 | 必須 | 実装済 |
| F-044 | 工賃PDF帳票出力 | 中 | 実装済 |
| F-045 | 工賃振込口座変更申請 | 必須 | 実装済 |
| F-046 | 工賃計算実行（運営管理） | 必須 | 実装済 |
| F-047 | 工賃計算プレビュー（運営管理） | 必須 | 実装済 |

#### 3.1.6 変更申請機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-050 | プラン変更申請 | 必須 | 実装済 |
| F-051 | ゲーム変更申請 | 必須 | 実装済 |
| F-052 | 利用者追加/削除申請 | 必須 | 実装済 |
| F-053 | PC追加/変更申請 | 必須 | 実装済 |
| F-054 | 支払方法変更申請 | 必須 | 実装済 |
| F-055 | 申請履歴表示 | 必須 | 実装済 |
| F-056 | 申請ステータス確認 | 必須 | 実装済 |

#### 3.1.7 契約情報機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-060 | 契約内容表示 | 必須 | 実装済 |
| F-061 | 契約プラン詳細表示 | 必須 | 実装済 |

#### 3.1.8 サポート機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-070 | FAQ表示 | 高 | 実装済 |
| F-071 | お問い合わせフォーム | 必須 | 実装済 |

#### 3.1.9 認証・セキュリティ機能
| ID | 機能名 | 優先度 | 状態 |
|----|-------|-------|------|
| F-080 | ログイン（メール/パスワード） | 必須 | 実装済 |
| F-081 | WordPress JWT認証連携 | 必須 | 実装済 |
| F-082 | セッション管理 | 必須 | 実装済 |
| F-083 | ロール別アクセス制御 | 必須 | 実装済 |
| F-084 | ログアウト | 必須 | 実装済 |

---

### 3.2 機能詳細

#### 3.2.1 ダッシュボード機能詳細

**F-001: 施設基本情報表示**
- 表示項目: 施設名、契約プラン、所在地、連絡先
- データソース: Facilityテーブル
- 更新頻度: リアルタイム

**F-002: 利用者数統計表示**
- 表示項目: アクティブ利用者数、総登録数
- データソース: Userテーブル（role=MEMBER, status=ACTIVE）
- 表示形式: 数値カード

**F-003: 継続月数・工賃フェーズ表示**
- 表示項目: サービス継続月数、現在の工賃フェーズ
- 工賃フェーズ:
  - フェーズ1（short）: 0〜3ヶ月
  - フェーズ2（mid）: 4〜9ヶ月
  - フェーズ3（long）: 9ヶ月以上
- 表示形式: 数値カード + プログレスバー

**F-005: Googleカレンダー連携**
- 表示項目: 今月のイベント一覧
- データソース: Google Calendar API
- 更新頻度: ページロード時

**F-006: お知らせ表示**
- 表示項目: 運営からのお知らせ一覧
- データソース: WordPress REST API
- 既読管理: NotificationReadテーブル

#### 3.2.2 利用者管理機能詳細

**F-010: 利用者一覧表示**
- 表示項目: イニシャル、名前、選択ゲーム、ステータス
- フィルタ: ステータス（アクティブ/退所）
- ソート: 名前順、登録日順

**F-015: モニタリングシート連携**
- 連携先: Google Spreadsheet
- シート種別:
  - entry: エントリープラン用
  - focus_simple: フォーカスプラン簡易版
  - focus_normal: フォーカスプラン通常版

#### 3.2.3 ゲーム管理機能詳細

**対応ゲーム一覧**
| ID | ゲーム名 | レベル |
|----|---------|-------|
| playbox | PLAY BOX | 1 |
| elf | エルフの森 | 1 |
| mcheroes | マイクリプトヒーローズ | 2 |
| axie-tri | Axieトライフォース | 2 |
| axie-quest | Axieクエスト | 3 |
| career | キャリア乙女サバイバー | 3 |
| bounty | バウンティカインズ | 3 |
| axie-origin | Axieオリジン | 4 |
| xeno | XENO | 4 |

#### 3.2.4 体調記録機能詳細

**記録項目**
| 項目 | 型 | 説明 |
|-----|---|------|
| fatigueLevel | 0-100 | 疲労度 |
| sleepHours | number | 睡眠時間 |
| mood | enum | 気分（5段階） |
| emotions | array | 感情タグ |
| weather | enum | 天気 |
| temperature | number | 気温 |
| hasPressureChange | boolean | 気圧変化 |
| achievedTasks | text | できたこと |
| difficultTasks | text | 難しかったこと |
| freeNotes | text | 自由記述 |

#### 3.2.5 工賃管理機能詳細

**契約プラン別の計算ルール**
| プラン | 日次上限 | 計算方式 |
|-------|---------|---------|
| エントリー | 上限なし | 固定50円/プレイ |
| フレキシブル | 在籍利用者数/日 | 高単価から優先採用 |
| フォーカス | 1回/人/日 | 高単価から優先採用 |

**工賃フェーズ別レート**
| フェーズ | 継続期間 | Lv1 | Lv2 | Lv3 | Lv4 |
|---------|---------|-----|-----|-----|-----|
| short | 0〜3ヶ月 | 50円 | 60円 | 70円 | 80円 |
| mid | 4〜9ヶ月 | 60円 | 70円 | 80円 | 90円 |
| long | 9ヶ月以上 | 70円 | 80円 | 90円 | 100円 |

**工賃計算ロジック**

1. **エントリープラン**
   ```
   月次工賃 = プレイ回数 × 50円（固定）
   ```

2. **フレキシブルプラン**
   ```
   日次工賃 = 上位N件（N=在籍利用者数）の合計
   月次工賃 = Σ(日次工賃)

   ※同日のプレイは工賃単価の高い順に採用
   ※上限超過分は「除外」扱い
   ```

3. **フォーカスプラン**
   ```
   日次工賃/人 = その日の最高単価プレイ1件のみ
   月次工賃 = Σ(各利用者の日次工賃)

   ※1人1日1プレイまで有効
   ※複数プレイした場合は最高単価のみ採用
   ```

**繰越金ルール**
- 月次合計が **1,000円未満** → 翌月へ繰越
- 月次合計が **1,000円以上** → 支払い実行
- 報酬額合計 = 前月繰越額 + 当月発生工賃

**月次処理フロー**
```
運営管理ポータル
    ↓
「工賃計算」画面で年月を選択
    ↓
「プレビュー」ボタン → 計算結果を確認（DB保存なし）
    ↓
結果確認・修正
    ↓
「確定」ボタン → 計算してDB保存
    ↓
施設ポータルに工賃データ反映
```

1. 運営スタッフが管理ポータルから対象年月を選択
2. プレビュー実行でスプレッドシートからプレイ記録を読み取り、計算結果を表示
3. 計算結果を確認（除外されたプレイの理由なども確認可能）
4. 問題なければ「確定」を押してDBに保存
5. 繰越金を計算し、1,000円以上なら支払い、未満なら繰越

#### 3.2.6 変更申請機能詳細

**申請種別**
| 申請種別 | 対象プラン | 必要情報 |
|---------|----------|---------|
| プラン変更 | 全プラン | 変更後プラン |
| ゲーム変更 | エントリー/フレキシブル | 変更後ゲーム一覧 |
| ゲーム変更 | フォーカス | 変更する利用者イニシャル、変更後ゲーム一覧 |
| 利用者追加 | 全プラン | 利用者情報 |
| 利用者削除 | 全プラン | 削除理由、希望日 |
| PC追加 | フレキシブル/フォーカス | 台数、用途 |
| PC変更 | 全プラン | 変更内容 |
| 支払方法変更 | 全プラン | 新支払方法 |
| 口座変更 | 全プラン | 新口座情報 |

**申請ステータス**
- PENDING: 申請中
- APPROVED: 承認済
- REJECTED: 却下

---

## 4. 非機能要件

### 4.1 性能要件
| 項目 | 要件 |
|-----|------|
| ページ表示速度 | 3秒以内 |
| API応答時間 | 500ms以内 |
| 同時接続数 | 100ユーザー |
| データ保持期間 | 7年間 |

### 4.2 可用性要件
| 項目 | 要件 |
|-----|------|
| 稼働率 | 99.5%以上 |
| 計画停止 | 月1回、深夜2時間以内 |
| 障害復旧時間 | 4時間以内 |
| バックアップ | 日次自動バックアップ |

### 4.3 セキュリティ要件
| 項目 | 要件 |
|-----|------|
| 認証方式 | JWT（7日間有効） |
| パスワード | bcryptハッシュ化 |
| 通信 | HTTPS必須 |
| アクセス制御 | ロールベース |
| 個人情報保護 | 施設単位のデータ分離 |

### 4.4 ユーザビリティ要件
| 項目 | 要件 |
|-----|------|
| 対応ブラウザ | Chrome, Safari, Edge（最新2バージョン） |
| レスポンシブ対応 | PC、タブレット |
| 言語 | 日本語 |
| アクセシビリティ | WCAG 2.1 AA準拠 |

### 4.5 運用要件
| 項目 | 要件 |
|-----|------|
| ログ保持 | 90日間 |
| 監視 | Vercel Analytics |
| デプロイ | Vercel自動デプロイ |
| 環境 | 本番、開発 |

---

## 5. 外部インターフェース要件

### 5.1 WordPress連携
| 項目 | 内容 |
|-----|------|
| 用途 | ユーザー認証、お知らせ取得 |
| プロトコル | REST API + JWT |
| 認証方式 | JWT Authentication for WP REST API |

### 5.2 Google連携
| サービス | 用途 |
|---------|------|
| Google Calendar | スケジュール表示 |
| Google Drive | ファイル保存 |
| Google Sheets | モニタリングシート |

### 5.3 データベース
| 項目 | 内容 |
|-----|------|
| DBMS | PostgreSQL 15+ |
| ホスティング | Supabase |
| ORM | Prisma |

### 5.4 工賃計算システム（アプリ内）
| 項目 | 内容 |
|-----|------|
| 用途 | 月次工賃計算・DB保存 |
| データソース | Google Spreadsheet（施設管理シート、利用者シート） |
| 処理タイミング | 運営管理ポータルから手動実行（月次） |
| 計算ロジック | `lib/services/wage-calculator.ts` |
| API | `POST /api/wages/calculate`（計算・保存）、`GET /api/wages/calculate/preview`（プレビュー） |

※ 旧GASによる工賃計算は廃止し、アプリ内で一元管理

---

## 6. 制約事項

### 6.1 技術的制約
- Next.js 14 App Routerを使用
- TypeScript必須
- Vercelへのデプロイを前提

### 6.2 ビジネス制約
- 施設データの他施設への漏洩を防ぐ
- 利用者の個人情報は施設単位で管理
- 工賃データは会計監査に対応可能な形式で保持

### 6.3 法的制約
- 個人情報保護法への準拠
- 障害者総合支援法の工賃規定への準拠

---

## 7. 用語集

| 用語 | 説明 |
|-----|------|
| 事業所/施設 | RevelAppを利用する福祉事業所 |
| 利用者 | 事業所でゲームをプレイする方 |
| 工賃 | 利用者に支払われる報酬 |
| プレイ回数 | ゲームをプレイした回数（工賃計算の基準） |
| モニタリングシート | 利用者の支援状況を記録するシート |
| 継続月数 | サービス利用開始からの月数 |
| 工賃フェーズ | 継続月数に応じた工賃レート段階（short/mid/long） |
| 繰越金 | 1,000円未満の未払い工賃を翌月へ持ち越した金額 |
| 報酬額合計 | 前月繰越額 + 当月発生工賃 |

---

## 8. 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|-------|
| 1.0 | 2026-01-07 | 初版作成 | Claude |
| 1.1 | 2026-01-07 | 要件修正（対象ユーザー、ゲーム一覧、工賃計算ロジック詳細化） | Claude |
| 1.2 | 2026-01-16 | 工賃計算をGASからアプリに移行、運営管理ポータルからの手動実行フローに変更 | Claude |
